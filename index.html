import React, { useState, useEffect } from 'react';
import { Users, Gift, UserPlus, Award, Download, RefreshCw, Clock, Trophy, Settings } from 'lucide-react';

export default function YearEndPartySystem() {
  const [view, setView] = useState('home'); // 'home', 'checkin', 'admin', 'admin-login'
  const [nicknamePool, setNicknamePool] = useState([]);
  const [participants, setParticipants] = useState([]);
  const [drawnParticipants, setDrawnParticipants] = useState([]);
  const [isSpinning, setIsSpinning] = useState(false);
  const [currentWinner, setCurrentWinner] = useState(null);
  const [showNicknamePopup, setShowNicknamePopup] = useState(false);
  const [assignedNickname, setAssignedNickname] = useState('');
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
  
  // Form states
  const [inputName, setInputName] = useState('');
  const [adminNicknameInput, setAdminNicknameInput] = useState('');
  const [adminPassword, setAdminPassword] = useState('');
  
  // M·∫≠t kh·∫©u admin - B·∫†N C√ì TH·ªÇ THAY ƒê·ªîI T·∫†I ƒê√ÇY
  const ADMIN_PASSWORD = 'yearend2024';

  // Load data from storage
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const poolResult = await window.storage.get('nickname-pool');
      const participantsResult = await window.storage.get('participants');
      const drawnResult = await window.storage.get('drawn-participants');
      
      if (poolResult) setNicknamePool(JSON.parse(poolResult.value));
      if (participantsResult) setParticipants(JSON.parse(participantsResult.value));
      if (drawnResult) setDrawnParticipants(JSON.parse(drawnResult.value));
    } catch (error) {
      console.log('No existing data');
    }
  };

  const saveData = async () => {
    try {
      await window.storage.set('nickname-pool', JSON.stringify(nicknamePool));
      await window.storage.set('participants', JSON.stringify(participants));
      await window.storage.set('drawn-participants', JSON.stringify(drawnParticipants));
    } catch (error) {
      console.error('Save error:', error);
    }
  };

  useEffect(() => {
    saveData();
  }, [nicknamePool, participants, drawnParticipants]);

  // Admin: Add nicknames to pool
  const addNicknamesToPool = () => {
    const lines = adminNicknameInput.split('\n').filter(line => line.trim());
    const newNicknames = lines.map(line => ({
      id: Date.now() + Math.random(),
      text: line.trim(),
      used: false
    }));
    setNicknamePool([...nicknamePool, ...newNicknames]);
    setAdminNicknameInput('');
  };

  const removeNicknameFromPool = (id) => {
    setNicknamePool(nicknamePool.filter(n => n.id !== id));
  };

  // Check-in: Assign random nickname
  const handleCheckin = () => {
    if (!inputName.trim()) return;
    
    const availableNicknames = nicknamePool.filter(n => !n.used);
    if (availableNicknames.length === 0) {
      alert('ƒê√£ h·∫øt bi·ªát danh! Vui l√≤ng li√™n h·ªá ban t·ªï ch·ª©c.');
      return;
    }

    const randomIndex = Math.floor(Math.random() * availableNicknames.length);
    const selectedNickname = availableNicknames[randomIndex];

    const newParticipant = {
      id: Date.now(),
      name: inputName.trim(),
      nickname: selectedNickname.text,
      nicknameId: selectedNickname.id,
      timestamp: new Date().toISOString(),
      hasWon: false
    };

    setParticipants([...participants, newParticipant]);
    setNicknamePool(nicknamePool.map(n => 
      n.id === selectedNickname.id ? {...n, used: true} : n
    ));
    
    // Show nickname popup
    setAssignedNickname(selectedNickname.text);
    setShowNicknamePopup(true);
    setInputName('');
  };

  const closeNicknamePopup = () => {
    setShowNicknamePopup(false);
    setAssignedNickname('');
  };

  // Admin: Lucky draw
  const spinLuckyDraw = () => {
    const eligibleParticipants = participants.filter(p => !p.hasWon);
    
    if (eligibleParticipants.length === 0) {
      alert('T·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë√£ ƒë∆∞·ª£c quay th∆∞·ªüng r·ªìi!');
      return;
    }

    setIsSpinning(true);
    let spinCount = 0;
    
    const spinInterval = setInterval(() => {
      const randomIndex = Math.floor(Math.random() * eligibleParticipants.length);
      setCurrentWinner(eligibleParticipants[randomIndex]);
      spinCount++;
      
      if (spinCount > 30) {
        clearInterval(spinInterval);
        setIsSpinning(false);
        
        const finalWinner = eligibleParticipants[Math.floor(Math.random() * eligibleParticipants.length)];
        setCurrentWinner(finalWinner);
        
        setParticipants(participants.map(p => 
          p.id === finalWinner.id ? {...p, hasWon: true} : p
        ));
        setDrawnParticipants([...drawnParticipants, {...finalWinner, wonAt: new Date().toISOString()}]);
      }
    }, 100);
  };

  const resetSystem = () => {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô h·ªá th·ªëng? D·ªØ li·ªáu s·∫Ω b·ªã x√≥a!')) {
      setNicknamePool([]);
      setParticipants([]);
      setDrawnParticipants([]);
      setCurrentWinner(null);
      
      window.storage.delete('nickname-pool').catch(() => {});
      window.storage.delete('participants').catch(() => {});
      window.storage.delete('drawn-participants').catch(() => {});
    }
  };

  const exportReport = () => {
    const report = participants.map((p, index) => ({
      'STT': index + 1,
      'Th·ªùi gian': new Date(p.timestamp).toLocaleString('vi-VN'),
      'Bi·ªát danh': p.nickname,
      'T√™n th·∫≠t': p.name,
      'ƒê√£ tr√∫ng th∆∞·ªüng': p.hasWon ? 'C√≥' : 'Ch∆∞a'
    }));
    
    const csv = [
      Object.keys(report[0]).join(','),
      ...report.map(row => Object.values(row).join(','))
    ].join('\n');
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `year-end-party-report-${Date.now()}.csv`;
    link.click();
  };

  // HOME VIEW
  if (view === 'home') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 p-8 flex items-center justify-center">
        <div className="max-w-4xl w-full">
          <div className="text-center mb-12">
            <div className="text-8xl mb-6">üéâ</div>
            <h1 className="text-6xl font-bold text-white mb-4 drop-shadow-lg">Year End Party 2025</h1>
            <p className="text-2xl text-white opacity-90">Ch√†o m·ª´ng ƒë·∫øn v·ªõi b·ªØa ti·ªác cu·ªëi nƒÉm!</p>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <button
              onClick={() => setView('checkin')}
              className="bg-white rounded-3xl p-12 shadow-2xl hover:shadow-3xl transition-all transform hover:scale-105 group"
            >
              <div className="text-7xl mb-6 group-hover:scale-110 transition-transform">üéä</div>
              <h2 className="text-3xl font-bold text-teal-600 mb-3">Check-in</h2>
              <p className="text-gray-600 text-lg">Nh·∫≠p t√™n ƒë·ªÉ nh·∫≠n bi·ªát danh c·ªßa b·∫°n</p>
              <div className="mt-6 bg-teal-100 text-teal-700 px-6 py-3 rounded-xl font-semibold">
                D√†nh cho kh√°ch m·ªùi ‚Üí
              </div>
            </button>

            <button
              onClick={() => setView('admin-login')}
              className="bg-white rounded-3xl p-12 shadow-2xl hover:shadow-3xl transition-all transform hover:scale-105 group"
            >
              <div className="text-7xl mb-6 group-hover:scale-110 transition-transform">üëë</div>
              <h2 className="text-3xl font-bold text-purple-600 mb-3">Admin</h2>
              <p className="text-gray-600 text-lg">Qu·∫£n l√Ω & quay s·ªë tr√∫ng th∆∞·ªüng</p>
              <div className="mt-6 bg-purple-100 text-purple-700 px-6 py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                üîí D√†nh cho BTC ‚Üí
              </div>
            </button>
          </div>
        </div>
      </div>
    );
  }

  // CHECK-IN VIEW
  if (view === 'checkin') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-500 via-teal-500 to-blue-500 p-8">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-3xl shadow-2xl p-12 relative">
            <button
              onClick={() => setView('home')}
              className="absolute top-6 left-6 text-gray-500 hover:text-gray-700 text-2xl"
            >
              ‚Üê Quay l·∫°i
            </button>

            <div className="text-center mb-8 mt-8">
              <div className="text-6xl mb-4">üéä</div>
              <h1 className="text-4xl font-bold text-teal-600 mb-2">Ch√†o m·ª´ng b·∫°n!</h1>
              <p className="text-gray-600 text-lg">Nh·∫≠p t√™n ƒë·ªÉ nh·∫≠n bi·ªát danh b√≠ ·∫©n</p>
            </div>

            <div className="mb-8">
              <input
                type="text"
                value={inputName}
                onChange={(e) => setInputName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleCheckin()}
                placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n"
                className="w-full px-6 py-5 text-xl border-4 border-teal-300 rounded-2xl focus:outline-none focus:border-teal-500 text-center font-semibold"
              />
            </div>

            <button
              onClick={handleCheckin}
              disabled={!inputName.trim()}
              className="w-full bg-gradient-to-r from-teal-500 to-blue-500 text-white py-6 rounded-2xl font-bold text-2xl hover:from-teal-600 hover:to-blue-600 transition-all shadow-lg flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <UserPlus size={28} />
              Nh·∫≠n bi·ªát danh ngay!
            </button>

            <div className="mt-8 text-center text-gray-500">
              <p className="text-sm">üí° H√£y nh·ªõ bi·ªát danh c·ªßa b·∫°n ƒë·ªÉ tham gia c√°c ho·∫°t ƒë·ªông!</p>
            </div>
          </div>

          {/* Nickname Popup */}
          {showNicknamePopup && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-3xl p-12 max-w-lg w-full text-center animate-bounce-in shadow-2xl">
                <div className="text-7xl mb-6">üé≠</div>
                <h2 className="text-3xl font-bold text-purple-600 mb-4">Bi·ªát danh c·ªßa b·∫°n l√†:</h2>
                <div className="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-8 mb-6 border-4 border-yellow-300">
                  <p className="text-5xl font-bold text-orange-600">"{assignedNickname}"</p>
                </div>
                <p className="text-xl text-gray-700 mb-8">üìå H√£y ghi nh·ªõ bi·ªát danh n√†y nh√©!</p>
                <button
                  onClick={closeNicknamePopup}
                  className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-10 py-4 rounded-xl font-bold text-xl hover:from-green-600 hover:to-emerald-600 transition-all"
                >
                  ƒê√£ nh·ªõ r·ªìi! ‚úì
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // ADMIN LOGIN VIEW
  if (view === 'admin-login') {
    const handleAdminLogin = () => {
      if (adminPassword === ADMIN_PASSWORD) {
        setIsAdminAuthenticated(true);
        setView('admin');
        setAdminPassword('');
      } else {
        alert('‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
        setAdminPassword('');
      }
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-500 p-8 flex items-center justify-center">
        <div className="max-w-md w-full">
          <div className="bg-white rounded-3xl shadow-2xl p-12 relative">
            <button
              onClick={() => setView('home')}
              className="absolute top-6 left-6 text-gray-500 hover:text-gray-700 text-2xl"
            >
              ‚Üê Quay l·∫°i
            </button>

            <div className="text-center mb-8 mt-8">
              <div className="text-7xl mb-4">üîí</div>
              <h1 className="text-4xl font-bold text-purple-600 mb-2">ƒêƒÉng nh·∫≠p Admin</h1>
              <p className="text-gray-600 text-lg">Ch·ªâ d√†nh cho Ban T·ªï Ch·ª©c</p>
            </div>

            <div className="mb-8">
              <input
                type="password"
                value={adminPassword}
                onChange={(e) => setAdminPassword(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                className="w-full px-6 py-5 text-xl border-4 border-purple-300 rounded-2xl focus:outline-none focus:border-purple-500 text-center font-semibold"
              />
            </div>

            <button
              onClick={handleAdminLogin}
              disabled={!adminPassword.trim()}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-6 rounded-2xl font-bold text-2xl hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              üîì ƒêƒÉng nh·∫≠p
            </button>

            <div className="mt-6 text-center text-sm text-gray-500">
              üí° Li√™n h·ªá BTC n·∫øu b·∫°n qu√™n m·∫≠t kh·∫©u
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ADMIN VIEW
  if (view === 'admin') {
    // Check authentication
    if (!isAdminAuthenticated) {
      setView('admin-login');
      return null;
    }

    const sortedParticipants = [...participants].sort((a, b) => 
      new Date(a.timestamp) - new Date(b.timestamp)
    );
    const eligibleCount = participants.filter(p => !p.hasWon).length;

    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-500 p-8">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-3xl shadow-2xl p-8">
            <div className="flex justify-between items-center mb-8">
              <div className="flex items-center gap-4">
                <button
                  onClick={() => setView('home')}
                  className="text-gray-500 hover:text-gray-700 text-2xl"
                >
                  ‚Üê Quay l·∫°i
                </button>
                <div>
                  <h1 className="text-4xl font-bold text-purple-600 mb-1">üëë Trang Qu·∫£n Tr·ªã</h1>
                  <p className="text-gray-600">Qu·∫£n l√Ω bi·ªát danh & quay th∆∞·ªüng</p>
                </div>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={exportReport}
                  className="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2"
                >
                  <Download size={20} />
                  Xu·∫•t b√°o c√°o
                </button>
                <button
                  onClick={resetSystem}
                  className="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all flex items-center gap-2"
                >
                  <RefreshCw size={20} />
                  Reset
                </button>
                <button
                  onClick={() => {
                    setIsAdminAuthenticated(false);
                    setView('home');
                  }}
                  className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2"
                >
                  üîí ƒêƒÉng xu·∫•t
                </button>
              </div>
            </div>

            {/* Nickname Pool Management */}
            <div className="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-2xl p-6 mb-8">
              <h2 className="text-2xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
                <Settings size={28} />
                Qu·∫£n l√Ω Kho Bi·ªát Danh
              </h2>
              <div className="grid grid-cols-3 gap-4 mb-6">
                <div className="bg-white rounded-xl p-4 text-center">
                  <div className="text-4xl font-bold text-indigo-600">{nicknamePool.length}</div>
                  <div className="text-sm text-gray-600 mt-1">T·ªïng c·ªông</div>
                </div>
                <div className="bg-white rounded-xl p-4 text-center">
                  <div className="text-4xl font-bold text-green-600">{nicknamePool.filter(n => !n.used).length}</div>
                  <div className="text-sm text-gray-600 mt-1">C√≤n l·∫°i</div>
                </div>
                <div className="bg-white rounded-xl p-4 text-center">
                  <div className="text-4xl font-bold text-gray-600">{nicknamePool.filter(n => n.used).length}</div>
                  <div className="text-sm text-gray-600 mt-1">ƒê√£ d√πng</div>
                </div>
              </div>

              <div className="bg-white rounded-xl p-4 mb-4">
                <textarea
                  value={adminNicknameInput}
                  onChange={(e) => setAdminNicknameInput(e.target.value)}
                  placeholder="Nh·∫≠p danh s√°ch bi·ªát danh (m·ªói d√≤ng 1 bi·ªát danh)&#10;V√≠ d·ª•:&#10;Si√™u nh√¢n Marketing&#10;Flash c·ªßa ph√≤ng IT&#10;C√† ph√™ ƒëen"
                  className="w-full h-32 px-4 py-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:border-indigo-500"
                />
                <button
                  onClick={addNicknamesToPool}
                  disabled={!adminNicknameInput.trim()}
                  className="w-full mt-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition-all font-bold disabled:opacity-50"
                >
                  ‚ûï Th√™m v√†o kho
                </button>
              </div>

              <div className="space-y-2 max-h-60 overflow-y-auto">
                {nicknamePool.map((n) => (
                  <div key={n.id} className={`rounded-lg p-3 flex justify-between items-center ${n.used ? 'bg-gray-100 opacity-60' : 'bg-white'}`}>
                    <span className={`font-medium ${n.used ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                      {n.text}
                    </span>
                    <div className="flex items-center gap-2">
                      {n.used && <span className="text-xs bg-red-500 text-white px-2 py-1 rounded">ƒê√£ d√πng</span>}
                      <button
                        onClick={() => removeNicknameFromPool(n.id)}
                        className="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm"
                      >
                        ‚úï
                      </button>
                    </div>
                  </div>
                ))}
                {nicknamePool.length === 0 && (
                  <div className="text-center py-8 text-gray-400">
                    Ch∆∞a c√≥ bi·ªát danh n√†o. Th√™m bi·ªát danh ƒë·ªÉ b·∫Øt ƒë·∫ßu!
                  </div>
                )}
              </div>
            </div>

            {/* Lucky Draw Section */}
            <div className="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-8 mb-8 border-4 border-yellow-300">
              <h2 className="text-3xl font-bold text-orange-600 mb-6 text-center flex items-center justify-center gap-3">
                <Trophy size={32} />
                Quay S·ªë Tr√∫ng Th∆∞·ªüng
              </h2>
              
              <div className="text-center mb-6">
                <p className="text-xl text-gray-700">
                  C√≤n <span className="font-bold text-orange-600">{eligibleCount}</span> ng∆∞·ªùi ch∆∞a quay
                </p>
              </div>

              {currentWinner && (
                <div className="bg-white rounded-xl p-8 mb-6 text-center border-4 border-yellow-400">
                  <div className="text-6xl mb-4">üéâ</div>
                  <h3 className="text-2xl text-gray-600 mb-2">Bi·ªát danh: "{currentWinner.nickname}"</h3>
                  <h3 className="text-4xl font-bold text-purple-600 mb-2">{currentWinner.name}</h3>
                  {!isSpinning && (
                    <div className="mt-4">
                      <span className="bg-green-500 text-white px-6 py-2 rounded-full font-bold text-lg">
                        üéä Ch√∫c m·ª´ng! üéä
                      </span>
                    </div>
                  )}
                </div>
              )}

              <button
                onClick={spinLuckyDraw}
                disabled={isSpinning || eligibleCount === 0}
                className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-6 rounded-xl font-bold text-2xl hover:from-orange-600 hover:to-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
              >
                <Gift size={32} />
                {isSpinning ? 'ƒêang quay...' : 'Quay th∆∞·ªüng ngay!'}
              </button>
            </div>

            {/* Winners List */}
            {drawnParticipants.length > 0 && (
              <div className="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-6 mb-6">
                <h3 className="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                  <Award size={24} />
                  Danh s√°ch ng∆∞·ªùi tr√∫ng th∆∞·ªüng ({drawnParticipants.length})
                </h3>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {drawnParticipants.map((p, index) => (
                    <div key={p.id} className="bg-white rounded-lg p-4 flex justify-between items-center">
                      <div>
                        <span className="font-bold text-green-600">#{index + 1}</span>
                        <span className="ml-3 text-purple-600">"{p.nickname}"</span>
                        <span className="mx-2 text-gray-400">‚Üí</span>
                        <span className="font-semibold text-gray-800">{p.name}</span>
                      </div>
                      <span className="text-sm text-gray-500">
                        {new Date(p.wonAt).toLocaleTimeString('vi-VN')}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Participants List - Sorted by time */}
            <div className="bg-gray-50 rounded-xl p-6">
              <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <Clock size={24} />
                Th·ªëng k√™ Check-in theo th·ªùi gian ({participants.length} ng∆∞·ªùi)
              </h3>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {sortedParticipants.map((p, index) => (
                  <div key={p.id} className={`rounded-lg p-4 flex justify-between items-center ${p.hasWon ? 'bg-green-50 border-2 border-green-300' : 'bg-white'}`}>
                    <div className="flex items-center gap-4 flex-1">
                      <span className="font-bold text-gray-500 w-10">#{index + 1}</span>
                      <div className="flex-1">
                        <div className="flex items-center gap-3">
                          <span className="text-sm text-gray-500 flex items-center gap-1">
                            <Clock size={14} />
                            {new Date(p.timestamp).toLocaleTimeString('vi-VN')}
                          </span>
                        </div>
                        <div className="mt-1">
                          <span className="text-purple-600 font-medium">"{p.nickname}"</span>
                          <span className="mx-2 text-gray-400">‚Üí</span>
                          <span className="font-semibold text-gray-800">{p.name}</span>
                        </div>
                      </div>
                    </div>
                    {p.hasWon && (
                      <span className="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold ml-4">
                        ‚úì ƒê√£ tr√∫ng
                      </span>
                    )}
                  </div>
                ))}
                {participants.length === 0 && (
                  <div className="text-center py-8 text-gray-400">
                    Ch∆∞a c√≥ ai check-in
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }
}
