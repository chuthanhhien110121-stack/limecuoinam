<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Year End Party 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    @keyframes bounce-in {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-bounce-in { animation: bounce-in 0.5s ease-out; }
  </style>
</head>
<body class="m-0 p-0">
  <div id="app"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDdzEbdm4xnnqZ4jxekn_5s2A90fCuDZfk",
      authDomain: "year-end-party-d4dff.firebaseapp.com",
      databaseURL: "https://year-end-party-d4dff-default-rtdb.firebaseio.com",
      projectId: "year-end-party-d4dff",
      storageBucket: "year-end-party-d4dff.firebasestorage.app",
      messagingSenderId: "866293512188",
      appId: "1:866293512188:web:65754bd03de5910021e479"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let state = {
      view: 'home',
      nicknamePool: [],
      participants: [],
      drawnParticipants: [],
      isAdminAuthenticated: false,
      currentWinner: null,
      isSpinning: false
    };

    const ADMIN_PASSWORD = 'yearend2024';

    // Firebase listeners
    db.ref('nicknamePool').on('value', (snap) => {
      state.nicknamePool = [];
      if (snap.exists()) {
        snap.forEach(child => {
          state.nicknamePool.push({ id: child.key, ...child.val() });
        });
      }
      if (state.view === 'admin') render();
    });

    db.ref('participants').on('value', (snap) => {
      state.participants = [];
      if (snap.exists()) {
        snap.forEach(child => {
          state.participants.push({ id: child.key, ...child.val() });
        });
      }
      if (state.view === 'admin') render();
    });

    db.ref('drawnParticipants').on('value', (snap) => {
      state.drawnParticipants = [];
      if (snap.exists()) {
        snap.forEach(child => {
          state.drawnParticipants.push({ id: child.key, ...child.val() });
        });
      }
      if (state.view === 'admin') render();
    });

    function renderHome() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 p-8 flex items-center justify-center">
          <div class="max-w-4xl w-full">
            <div class="text-center mb-12">
              <div class="text-8xl mb-6">ğŸ‰</div>
              <h1 class="text-6xl font-bold text-white mb-4 drop-shadow-lg">Year End Party 2025</h1>
              <p class="text-2xl text-white opacity-90">ChÃ o má»«ng Ä‘áº¿n vá»›i bá»¯a tiá»‡c cuá»‘i nÄƒm!</p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
              <button onclick="setView('checkin')" class="bg-white rounded-3xl p-12 shadow-2xl hover:shadow-3xl transition-all transform hover:scale-105 group">
                <div class="text-7xl mb-6 group-hover:scale-110 transition-transform">ğŸŠ</div>
                <h2 class="text-3xl font-bold text-teal-600 mb-3">Check-in</h2>
                <p class="text-gray-600 text-lg">Nháº­p tÃªn Ä‘á»ƒ nháº­n biá»‡t danh cá»§a báº¡n</p>
                <div class="mt-6 bg-teal-100 text-teal-700 px-6 py-3 rounded-xl font-semibold">DÃ nh cho khÃ¡ch má»i â†’</div>
              </button>
              <button onclick="setView('admin-login')" class="bg-white rounded-3xl p-12 shadow-2xl hover:shadow-3xl transition-all transform hover:scale-105 group">
                <div class="text-7xl mb-6 group-hover:scale-110 transition-transform">ğŸ‘‘</div>
                <h2 class="text-3xl font-bold text-purple-600 mb-3">Admin</h2>
                <p class="text-gray-600 text-lg">Quáº£n lÃ½ & quay sá»‘ trÃºng thÆ°á»Ÿng</p>
                <div class="mt-6 bg-purple-100 text-purple-700 px-6 py-3 rounded-xl font-semibold flex items-center justify-center gap-2">ğŸ”’ DÃ nh cho BTC â†’</div>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderCheckin() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-green-500 via-teal-500 to-blue-500 p-8">
          <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-12 relative">
              <button onclick="setView('home')" class="absolute top-6 left-6 text-gray-500 hover:text-gray-700 text-2xl">â† Quay láº¡i</button>
              <div class="text-center mb-8 mt-8">
                <div class="text-6xl mb-4">ğŸŠ</div>
                <h1 class="text-4xl font-bold text-teal-600 mb-2">ChÃ o má»«ng báº¡n!</h1>
                <p class="text-gray-600 text-lg">Nháº­p tÃªn Ä‘á»ƒ nháº­n biá»‡t danh bÃ­ áº©n</p>
              </div>
              <div class="mb-8">
                <input type="text" id="inputName" placeholder="Nháº­p há» tÃªn cá»§a báº¡n" 
                  class="w-full px-6 py-5 text-xl border-4 border-teal-300 rounded-2xl focus:outline-none focus:border-teal-500 text-center font-semibold"
                  onkeypress="if(event.key==='Enter') handleCheckin()">
              </div>
              <button onclick="handleCheckin()" 
                class="w-full bg-gradient-to-r from-teal-500 to-blue-500 text-white py-6 rounded-2xl font-bold text-2xl hover:from-teal-600 hover:to-blue-600 transition-all shadow-lg">
                âœ¨ Nháº­n biá»‡t danh ngay!
              </button>
              <div class="mt-8 text-center text-gray-500">
                <p class="text-sm">ğŸ’¡ HÃ£y nhá»› biá»‡t danh cá»§a báº¡n Ä‘á»ƒ tham gia cÃ¡c hoáº¡t Ä‘á»™ng!</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminLogin() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-500 p-8 flex items-center justify-center">
          <div class="max-w-md w-full">
            <div class="bg-white rounded-3xl shadow-2xl p-12 relative">
              <button onclick="setView('home')" class="absolute top-6 left-6 text-gray-500 hover:text-gray-700 text-2xl">â† Quay láº¡i</button>
              <div class="text-center mb-8 mt-8">
                <div class="text-7xl mb-4">ğŸ”’</div>
                <h1 class="text-4xl font-bold text-purple-600 mb-2">ÄÄƒng nháº­p Admin</h1>
                <p class="text-gray-600 text-lg">Chá»‰ dÃ nh cho Ban Tá»• Chá»©c</p>
              </div>
              <div class="mb-8">
                <input type="password" id="adminPassword" placeholder="Nháº­p máº­t kháº©u"
                  class="w-full px-6 py-5 text-xl border-4 border-purple-300 rounded-2xl focus:outline-none focus:border-purple-500 text-center font-semibold"
                  onkeypress="if(event.key==='Enter') handleAdminLogin()">
              </div>
              <button onclick="handleAdminLogin()"
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-6 rounded-2xl font-bold text-2xl hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg">
                ğŸ”“ ÄÄƒng nháº­p
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdmin() {
      const sorted = [...state.participants].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      const eligible = state.participants.filter(p => !p.hasWon).length;

      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-500 p-8">
          <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
              <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                <div class="flex items-center gap-4">
                  <button onclick="setView('home')" class="text-gray-500 hover:text-gray-700 text-2xl">â† Quay láº¡i</button>
                  <div>
                    <h1 class="text-4xl font-bold text-purple-600 mb-1">ğŸ‘‘ Trang Quáº£n Trá»‹</h1>
                    <p class="text-gray-600">Quáº£n lÃ½ biá»‡t danh & quay thÆ°á»Ÿng</p>
                  </div>
                </div>
                <div class="flex gap-3 flex-wrap">
                  <button onclick="exportReport()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all">ğŸ“¥ Xuáº¥t bÃ¡o cÃ¡o</button>
                  <button onclick="resetSystem()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all">ğŸ”„ Reset</button>
                  <button onclick="handleLogout()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">ğŸ”’ ÄÄƒng xuáº¥t</button>
                </div>
              </div>

              <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-2xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">âš™ï¸ Quáº£n lÃ½ Kho Biá»‡t Danh</h2>
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-4xl font-bold text-indigo-600">${state.nicknamePool.length}</div>
                    <div class="text-sm text-gray-600 mt-1">Tá»•ng cá»™ng</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-4xl font-bold text-green-600">${state.nicknamePool.filter(n => !n.used).length}</div>
                    <div class="text-sm text-gray-600 mt-1">CÃ²n láº¡i</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-4xl font-bold text-gray-600">${state.nicknamePool.filter(n => n.used).length}</div>
                    <div class="text-sm text-gray-600 mt-1">ÄÃ£ dÃ¹ng</div>
                  </div>
                </div>
                <div class="bg-white rounded-xl p-4 mb-4">
                  <textarea id="nicknameInput" placeholder="Nháº­p danh sÃ¡ch biá»‡t danh (má»—i dÃ²ng 1 biá»‡t danh)&#10;VÃ­ dá»¥:&#10;SiÃªu nhÃ¢n Marketing&#10;Flash cá»§a phÃ²ng IT&#10;CÃ  phÃª Ä‘en"
                    class="w-full h-32 px-4 py-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:border-indigo-500"></textarea>
                  <button onclick="addNicknames()" class="w-full mt-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition-all font-bold">â• ThÃªm vÃ o kho</button>
                </div>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                  ${state.nicknamePool.map(n => `
                    <div class="rounded-lg p-3 flex justify-between items-center ${n.used ? 'bg-gray-100 opacity-60' : 'bg-white'}">
                      <span class="font-medium ${n.used ? 'line-through text-gray-500' : 'text-gray-800'}">${n.text}</span>
                      <div class="flex items-center gap-2">
                        ${n.used ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">ÄÃ£ dÃ¹ng</span>' : ''}
                        <button onclick="removeNickname('${n.id}')" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm">âœ•</button>
                      </div>
                    </div>
                  `).join('') || '<div class="text-center py-8 text-gray-400">ChÆ°a cÃ³ biá»‡t danh nÃ o</div>'}
                </div>
              </div>

              <div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-8 mb-8 border-4 border-yellow-300">
                <h2 class="text-3xl font-bold text-orange-600 mb-6 text-center">ğŸ† Quay Sá»‘ TrÃºng ThÆ°á»Ÿng</h2>
                <div class="text-center mb-6">
                  <p class="text-xl text-gray-700">CÃ²n <span class="font-bold text-orange-600">${eligible}</span> ngÆ°á»i chÆ°a quay</p>
                </div>
                ${state.currentWinner ? `
                  <div class="bg-white rounded-xl p-8 mb-6 text-center border-4 border-yellow-400">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-2xl text-gray-600 mb-2">Biá»‡t danh: "${state.currentWinner.nickname}"</h3>
                    <h3 class="text-4xl font-bold text-purple-600 mb-2">${state.currentWinner.name}</h3>
                    ${!state.isSpinning ? '<div class="mt-4"><span class="bg-green-500 text-white px-6 py-2 rounded-full font-bold text-lg">ğŸŠ ChÃºc má»«ng! ğŸŠ</span></div>' : ''}
                  </div>
                ` : ''}
                <button onclick="spinLuckyDraw()" ${eligible === 0 ? 'disabled' : ''}
                  class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-6 rounded-xl font-bold text-2xl hover:from-orange-600 hover:to-red-600 transition-all disabled:opacity-50">
                  ğŸ ${state.isSpinning ? 'Äang quay...' : 'Quay thÆ°á»Ÿng ngay!'}
                </button>
              </div>

              ${state.drawnParticipants.length > 0 ? `
                <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-6 mb-6">
                  <h3 class="text-xl font-bold text-green-700 mb-4">ğŸ–ï¸ Danh sÃ¡ch ngÆ°á»i trÃºng thÆ°á»Ÿng (${state.drawnParticipants.length})</h3>
                  <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${state.drawnParticipants.map((p, i) => `
                      <div class="bg-white rounded-lg p-4 flex justify-between items-center">
                        <div>
                          <span class="font-bold text-green-600">#${i + 1}</span>
                          <span class="ml-3 text-purple-600">"${p.nickname}"</span>
                          <span class="mx-2 text-gray-400">â†’</span>
                          <span class="font-semibold text-gray-800">${p.name}</span>
                        </div>
                        <span class="text-sm text-gray-500">${new Date(p.wonAt).toLocaleTimeString('vi-VN')}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              <div class="bg-gray-50 rounded-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">â° Thá»‘ng kÃª Check-in (${state.participants.length} ngÆ°á»i)</h3>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                  ${sorted.map((p, i) => `
                    <div class="rounded-lg p-4 flex justify-between items-center ${p.hasWon ? 'bg-green-50 border-2 border-green-300' : 'bg-white'}">
                      <div class="flex items-center gap-4 flex-1">
                        <span class="font-bold text-gray-500 w-10">#${i + 1}</span>
                        <div class="flex-1">
                          <div class="text-sm text-gray-500">â° ${new Date(p.timestamp).toLocaleTimeString('vi-VN')}</div>
                          <div class="mt-1">
                            <span class="text-purple-600 font-medium">"${p.nickname}"</span>
                            <span class="mx-2 text-gray-400">â†’</span>
                            <span class="font-semibold text-gray-800">${p.name}</span>
                          </div>
                        </div>
                      </div>
                      ${p.hasWon ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold ml-4">âœ“ ÄÃ£ trÃºng</span>' : ''}
                    </div>
                  `).join('') || '<div class="text-center py-8 text-gray-400">ChÆ°a cÃ³ ai check-in</div>'}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showNicknamePopup(nickname) {
      const popup = document.createElement('div');
      popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      popup.innerHTML = `
        <div class="bg-white rounded-3xl p-12 max-w-lg w-full text-center shadow-2xl animate-bounce-in">
          <div class="text-7xl mb-6">ğŸ­</div>
          <h2 class="text-3xl font-bold text-purple-600 mb-4">Biá»‡t danh cá»§a báº¡n lÃ :</h2>
          <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-8 mb-6 border-4 border-yellow-300">
            <p class="text-5xl font-bold text-orange-600">"${nickname}"</p>
          </div>
          <p class="text-xl text-gray-700 mb-8">ğŸ“Œ HÃ£y ghi nhá»› biá»‡t danh nÃ y nhÃ©!</p>
          <button onclick="this.parentElement.parentElement.remove()"
            class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-10 py-4 rounded-xl font-bold text-xl hover:from-green-600 hover:to-emerald-600 transition-all">
            ÄÃ£ nhá»› rá»“i! âœ“
          </button>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function setView(view) {
      state.view = view;
      render();
    }

    async function handleCheckin() {
      const input = document.getElementById('inputName');
      const name = input.value.trim();
      
      if (!name) {
        alert('Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n!');
        return;
      }
      
      const available = state.nicknamePool.filter(n => !n.used);
      if (available.length === 0) {
        alert('ÄÃ£ háº¿t biá»‡t danh! Vui lÃ²ng liÃªn há»‡ ban tá»• chá»©c.');
        return;
      }

      const random = available[Math.floor(Math.random() * available.length)];
      
      try {
        await db.ref('participants').push({
          name: name,
          nickname: random.text,
          timestamp: new Date().toISOString(),
          hasWon: false
        });

        await db.ref('nicknamePool/' + random.id).update({ used: true });
        showNicknamePopup(random.text);
        input.value = '';
      } catch (err) {
        console.error(err);
        alert('CÃ³ lá»—i xáº£y ra! Vui lÃ²ng thá»­ láº¡i.');
      }
    }

    function handleAdminLogin() {
      const input = document.getElementById('adminPassword');
      if (input.value === ADMIN_PASSWORD) {
        state.isAdminAuthenticated = true;
        state.view = 'admin';
        render();
      } else {
        alert('âŒ Máº­t kháº©u khÃ´ng Ä‘Ãºng!');
        input.value = '';
      }
    }

    function handleLogout() {
      state.isAdminAuthenticated = false;
      state.view = 'home';
      render();
    }

    async function addNicknames() {
      const input = document.getElementById('nicknameInput');
      const lines = input.value.split('\n').map(l => l.trim()).filter(Boolean);

      if (lines.length === 0) {
        alert('Vui lÃ²ng nháº­p Ã­t nháº¥t 1 biá»‡t danh!');
        return;
      }

      try {
        for (const text of lines) {
          await db.ref('nicknamePool').push({ text: text, used: false });
        }
        input.value = '';
        alert(`âœ… ÄÃ£ thÃªm ${lines.length} biá»‡t danh!`);
      } catch (err) {
        console.error(err);
        alert('CÃ³ lá»—i! Vui lÃ²ng thá»­ láº¡i.');
      }
    }

    async function removeNickname(id) {
      if (confirm('XÃ³a biá»‡t danh nÃ y?')) {
        try {
          await db.ref('nicknamePool/' + id).remove();
        } catch (err) {
          console.error(err);
          alert('CÃ³ lá»—i! Vui lÃ²ng thá»­ láº¡i.');
        }
      }
    }

    function spinLuckyDraw() {
      const eligible = state.participants.filter(p => !p.hasWon);
      if (eligible.length === 0) {
        alert('Táº¥t cáº£ Ä‘Ã£ Ä‘Æ°á»£c quay rá»“i!');
        return;
      }

      state.isSpinning = true;
      let count = 0;
      
      const interval = setInterval(async () => {
        state.currentWinner = eligible[Math.floor(Math.random() * eligible.length)];
        render();
        count++;
        
        if (count > 30) {
          clearInterval(interval);
          state.isSpinning = false;
          
          const winner = eligible[Math.floor(Math.random() * eligible.length)];
          state.currentWinner = winner;
          
          try {
            await db.ref('participants/' + winner.id).update({ hasWon: true });
            await db.ref('drawnParticipants').push({ ...winner, wonAt: new Date().toISOString() });
            render();
          } catch (err) {
            console.error(err);
            alert('Lá»—i lÆ°u káº¿t quáº£!');
          }
        }
      }, 100);
    }

    async function resetSystem() {
      if (confirm('Reset toÃ n bá»™? Dá»¯ liá»‡u sáº½ máº¥t!')) {
        try {
          await db.ref('nicknamePool').remove();
          await db.ref('participants').remove();
          await db.ref('drawnParticipants').remove();
          alert('âœ… ÄÃ£ reset!');
          render();
        } catch (err) {
          console.error(err);
          alert('CÃ³ lá»—i!');
        }
      }
    }

    function exportReport() {
      const csv = [
        'STT,Thoi gian,Biet danh,Ten that,Da trung thuong',
        ...state.participants.map((p, i) => [
          i + 1,
          new Date(p.timestamp).toLocaleString('vi-VN'),
          p.nickname,
          p.name,
          p.hasWon ? 'Co' : 'Chua'
        ].join(','))
      ].join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `year-end-party-${Date.now()}.csv`;
      link.click();
    }

    function render() {
      const app = document.getElementById('app');
      
      switch(state.view) {
        case 'home': app.innerHTML = renderHome(); break;
        case 'checkin': app.innerHTML = renderCheckin(); break;
        case 'admin-login': app.innerHTML = renderAdminLogin(); break;
        case 'admin':
          if (!state.isAdminAuthenticated) {
            state.view = 'admin-login';
            app.innerHTML = renderAdminLogin();
          } else {
            app.innerHTML = renderAdmin();
          }
          break;
      }
    }

    render();
  </script>
</body>
</html>
